<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Giọng Nói (Local-Whisper)</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background-color: #f0f2f5; }
        #recordButton { padding: 20px; font-size: 1.2em; cursor: pointer; border-radius: 50%; border: none; width: 100px; height: 100px; background-color: #007bff; color: white; transition: background-color 0.3s, transform 0.1s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        #recordButton.recording { background-color: #dc3545; transform: scale(1.1); }
        #transcript { margin-top: 30px; width: 80%; max-width: 600px; padding: 20px; border: 1px solid #ccc; border-radius: 8px; min-height: 100px; background-color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #status { margin-top: 15px; color: #6c757d; }
    </style>
</head>
<body>

    <button id="recordButton">Nhấn Nói</button>
    <div id="status">Trạng thái: Sẵn sàng</div>
    <div id="transcript">
        <p><em>Văn bản chuyển đổi sẽ xuất hiện ở đây...</em></p>
    </div>

    <script>
        const recordButton = document.getElementById('recordButton');
        const statusDiv = document.getElementById('status');
        const transcriptDiv = document.getElementById('transcript');

        let isRecording = false;
        let mediaRecorder;
        let ws;
        let audioContext;
        let processor;
        let source;

        const CHUNK_DURATION_MS = 1000; // Gửi dữ liệu mỗi 1 giây

        recordButton.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        function connectWebSocket() {
            // Xác định địa chỉ WebSocket
            const protocol = window.location.protocol === 'https' ? 'wss' : 'ws';
            const wsUrl = `${protocol}://${window.location.host}/stream`;
            
            statusDiv.textContent = 'Đang kết nối tới server...';
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                statusDiv.textContent = 'Kết nối thành công. Bắt đầu ghi âm...';
                recordButton.textContent = 'Dừng';
                recordButton.classList.add('recording');
                isRecording = true;
                startMicrophone();
            };

            ws.onmessage = (event) => {
                // Nhận văn bản từ server và hiển thị
                transcriptDiv.textContent = event.data;
            };

            ws.onerror = (error) => {
                console.error('WebSocket Error:', error);
                statusDiv.textContent = 'Lỗi kết nối WebSocket.';
                stopRecordingCleanup();
            };

            ws.onclose = () => {
                statusDiv.textContent = 'Đã ngắt kết nối. Sẵn sàng.';
                stopRecordingCleanup();
            };
        }
        
        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(stream => {
                    connectWebSocket();
                }).catch(err => {
                    alert('Không thể truy cập micro. Vui lòng cấp quyền.');
                    console.error('getUserMedia error:', err);
                });
        }
        
        function startMicrophone() {
            navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then(stream => {
                 audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000 // Yêu cầu sample rate 16000Hz
                });
                source = audioContext.createMediaStreamSource(stream);
                processor = audioContext.createScriptProcessor(4096, 1, 1); // bufferSize, inputChannels, outputChannels

                processor.onaudioprocess = (e) => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        // Lấy dữ liệu PCM float32 và gửi đi
                        const float32Array = e.inputBuffer.getChannelData(0);
                        ws.send(float32Array.buffer);
                    }
                };
                
                source.connect(processor);
                processor.connect(audioContext.destination);
            });
        }
        
        function stopRecording() {
            if (ws) {
                ws.close();
            }
        }

        function stopRecordingCleanup() {
            if (processor) {
                processor.disconnect();
                processor = null;
            }
            if (source) {
                source.disconnect();
                source = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            recordButton.textContent = 'Nhấn Nói';
            recordButton.classList.remove('recording');
            isRecording = false;
        }

    </script>
</body>
</html>
